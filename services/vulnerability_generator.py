import random

VULNERABILITY_TYPES = [
    'sql_injection',
    'xss',
    'csrf',
    'insecure_direct_object_reference',
    'broken_authentication',
    'sensitive_data_exposure',
]

def generate_vulnerability():
    vulnerability_type = random.choice(VULNERABILITY_TYPES)
    
    if vulnerability_type == 'sql_injection':
        return generate_sql_injection()
    elif vulnerability_type == 'xss':
        return generate_xss()
    elif vulnerability_type == 'csrf':
        return generate_csrf()
    elif vulnerability_type == 'insecure_direct_object_reference':
        return generate_idor()
    elif vulnerability_type == 'broken_authentication':
        return generate_broken_auth()
    elif vulnerability_type == 'sensitive_data_exposure':
        return generate_data_exposure()

def generate_sql_injection():
    vulnerable_code = """
    @bp.route('/search')
    def search():
        query = request.args.get('q')
        results = db.engine.execute(f"SELECT * FROM products WHERE name LIKE '%{query}%'")
        return render_template('search_results.html', results=results)
    """
    exploit_info = "To exploit this vulnerability, try entering a malicious SQL query in the search box, such as: ' UNION SELECT * FROM users--"
    fix_info = "To fix this vulnerability, use parameterized queries or ORM methods instead of string concatenation."
    return ('routes/shop.py', vulnerable_code, 'SQL Injection', exploit_info, fix_info)

def generate_xss():
    vulnerable_code = """
    @bp.route('/profile')
    @login_required
    def profile():
        return render_template('profile.html', user_input=request.args.get('name', ''))
    """
    exploit_info = "To exploit this vulnerability, try entering a malicious script in the name parameter, such as: <script>alert('XSS')</script>"
    fix_info = "To fix this vulnerability, use proper output encoding and input validation."
    return ('routes/auth.py', vulnerable_code, 'Cross-Site Scripting (XSS)', exploit_info, fix_info)

def generate_csrf():
    vulnerable_code = """
    @bp.route('/change_password', methods=['POST'])
    @login_required
    def change_password():
        new_password = request.form['new_password']
        current_user.set_password(new_password)
        db.session.commit()
        return redirect(url_for('auth.profile'))
    """
    exploit_info = "To exploit this vulnerability, create a malicious website that submits a form to change the user's password without their knowledge."
    fix_info = "To fix this vulnerability, implement CSRF tokens and validate them on the server-side."
    return ('routes/auth.py', vulnerable_code, 'Cross-Site Request Forgery (CSRF)', exploit_info, fix_info)

def generate_idor():
    vulnerable_code = """
    @bp.route('/order/<int:order_id>')
    @login_required
    def order_detail(order_id):
        order = Order.query.get(order_id)
        return render_template('order_detail.html', order=order)
    """
    exploit_info = "To exploit this vulnerability, try accessing orders by changing the order_id parameter to view other users' orders."
    fix_info = "To fix this vulnerability, implement proper access controls and verify that the current user has permission to view the requested order."
    return ('routes/shop.py', vulnerable_code, 'Insecure Direct Object Reference', exploit_info, fix_info)

def generate_broken_auth():
    vulnerable_code = """
    @bp.route('/login', methods=['POST'])
    def login():
        username = request.form['username']
        password = request.form['password']
        user = User.query.filter_by(username=username).first()
        if user and user.password == password:
            login_user(user)
            return redirect(url_for('shop.index'))
        return redirect(url_for('auth.login'))
    """
    exploit_info = "To exploit this vulnerability, try brute-forcing passwords or using SQL injection in the username field."
    fix_info = "To fix this vulnerability, use secure password hashing, implement proper authentication mechanisms, and use parameterized queries."
    return ('routes/auth.py', vulnerable_code, 'Broken Authentication', exploit_info, fix_info)

def generate_data_exposure():
    vulnerable_code = """
    @bp.route('/api/users')
    def get_users():
        users = User.query.all()
        return jsonify([{'id': user.id, 'username': user.username, 'email': user.email} for user in users])
    """
    exploit_info = "To exploit this vulnerability, simply access the /api/users endpoint to retrieve sensitive user information."
    fix_info = "To fix this vulnerability, implement proper authentication and authorization for API endpoints, and limit the exposed data to only what's necessary."
    return ('routes/admin.py', vulnerable_code, 'Sensitive Data Exposure', exploit_info, fix_info)

if __name__ == '__main__':
    print(generate_vulnerability())
